---
title: "RAG on Hacker News comments to generate a research summary"
description: "Learn how to search Hacker News comments for a topic, extract sentiment, and generate a research summary in 34 lines of Substrate code. Runs dozens of LLM calls in parallel and streams markdown. Built in 15 minutes, easy to remix."
date: 2024-07-15
image: "/hnrag.png"
---

In this post, we'll show you how to search Hacker News comments for a topic, extract sentiment, and generate a research summary in 34 lines of code using Substrate.

- [Read on Twitter](https://x.com/vprtwn/status/1812844236401762513)
- [Read on LinkedIn](https://www.linkedin.com/pulse/rag-hacker-news-comments-34-lines-code-substratelabs-pouje)

This concise RAG implementation runs dozens of LLM calls in parallel and streams the markdown in no time. It's easy to remix, and genuinely useful. Internally, we've already written several scripts like this for Reddit, LinkedIn, and Twitter, and set up alerts to Slack.

<iframe
  width="100%"
  height="600px"
  src="https://www.val.town/embed/substrate/hackerNewsRAG"
  title="Val Town"
  frameBorder="0"
  allowFullScreen
></iframe>

First, we search HackerNews comments using the [Algolia HN Search API](https://hn.algolia.com/api).

```typescript
const searchResults = await hnSearch({
  query: query,
  numericFilters: `created_at_i>${Math.floor(Date.now() / 1000) - 60 * 60 * 24 * 7 * 4}`,
  tags: "comment",
});
```

Next, we use ComputeJSON to extract summary, sentiment, and other metadata from each comment. Structured JSON generation is ergonomic, reliable and blazing-fast on Substrate compared to other providers. This is critical for multi-step workflows.

```typescript
let summaries = [];
for (const hit of searchResults.hits) {
  summaries.push(
    new ComputeJSON({
      prompt: `Summarize this comment and how it relates to the topic: ${query}
      Use "negative" sentiment for posts about API, abstraction, documentation, tutorial, general quality, slowness, or performance issues.
      COMMENT: ${JSON.stringify(hit)}`,
      json_schema: zodToJsonSchema(commentInfo),
    }),
  );
}
```

Finally, we use ComputeText to generate a markdown summary of all the extracted JSON, and stream the results. Streaming on Substrate is really cool. You can of course stream the response of an individual LLM. But you can also stream the incremental steps of your workflow.

```typescript
const markdown = new ComputeText({
  prompt: sb.concat(
    `Below is a list of summarized comments about ${query} on Hacker News.
  Generate concise markdown summarizing the results.
  Summarize the contents of the comment and the sentiment about ${query}.
  Categorize results under sentiment headers.
  Order from most negative to least negative within each category.
  Add a link to the original story URL in this format: [<story title>](https://news.ycombinator.com/item?id=<objectID>)
  Filter out posts that do not seem to be about ${query}.
  RESULTS:\n`,
    ...summaries.map((s) => sb.jq(s.future.json_object, "@json")),
  ),
  model: "Llama3Instruct70B",
});
const stream = await substrate.stream(markdown);
```

The code we wrote was really simple. Implicitly, we were creating the graph below. But we didn't have to think about the graph at all! With Substrate, by simply relating tasks to each other, we get automatic parallelization of dozens of LLM calls for free, and 0 roundtrips.

![graph](/hnrag-graph.png)

Great power with great simplicity.

View the full source, fork, and remix here: https://www.val.town/v/substrate/hackerNewsRAG

- [Read on Twitter](https://x.com/vprtwn/status/1812844236401762513)
- [Read on LinkedIn](https://www.linkedin.com/pulse/rag-hacker-news-comments-34-lines-code-substratelabs-pouje)
